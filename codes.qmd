---
title: "final project"
format: pdf
editor: visual
---

```{r}
library(pacman)
p_load(tidyverse,ggplot2,haven,interactions,sjPlot,psych)
```

```{r}
dta <- readRDS("data/WVS_Cross-National_Wave_7_rds_v6_0.rds")
```

```{r}
dta$B_COUNTRY_num <- as.numeric(dta$B_COUNTRY)
#extract needed variables
df_analysis <- dta %>%
  filter(B_COUNTRY_num %in% c(344, 702, 158, 156)) %>% 
  select(
    Country = B_COUNTRY_num,
    Q121, # The Overall impact of immigrants on the country (1-5, 5=Very Good)
    Q124, Q126, Q128, Q129, # Perceived harms (Crime, Terror, Jobs, Conflict)(0-2,2 means agree, which is the most negative view)
    Q69, Q70, Q71, Q74,     # Government Trust (Police, Courts, Gov, Civil Service)(1-4,1 means trust the most)
#   Q21,  #This is causeing post-treatment effect. Neighbor Preference (Immigrants/Foreign workers)(1 is dislike, 2 is did not meantion)
    Q275, Q288, Q262    # Controls: Education(1-8,larger better), Income(1-10, larger better), Age
  ) %>%
  zap_labels() %>%
  mutate(across(everything(), as.numeric))

# reorgnize the variables
df_clean <- df_analysis %>%
  # Convert unusual values to R's NA
  mutate(across(everything(), ~ifelse(.x < 0, NA, .x))) %>%
  mutate(
    Region = factor(Country, 
                    levels = c(344, 702, 158, 156), 
                    labels = c("Hong Kong", "Singapore", "Taiwan", "China")),
    
    # Dependent Variable: General View (High = Positive)
    ImpactOnCountry = Q121, 
    
    # Independent Variable: Multi-dimensional Harm Index (0-2)
    X_Harm_Index = rowMeans(across(c(Q124, Q126, Q128, Q129)), na.rm = TRUE),
    
    # Moderator: Institutional Trust Index (Combined Q69, Q70, Q71, Q74)
    # Recoded: 5 - original score so that 4 = High Trust, 1 = No Trust
    Inst_Trust_Index = rowMeans(across(c(Q69, Q70, Q71, Q74), ~ 5 - .x), na.rm = TRUE),
    
    # Dummy Variable: Personal Neighbor Preference (Q21)
    # This is causing post-treatment effect and thus desert here. 
    # 1 = Mentioned (Dislikes immigrant neighbors), 0 = Not mentioned (Accepts/Neutral)
    # Neighbor_Dislike = ifelse(Q21 == 1, 1, 0),
    
    Edu = Q275, Income = Q288, Age = Q262
  ) %>%
  # Remove cases with missing values in key analytical variables
  drop_na(ImpactOnCountry, X_Harm_Index, Inst_Trust_Index, Edu)

# Mean-Centering for better analysis
df_clean <- df_clean %>%
  mutate(
    PerceivedHarm = X_Harm_Index - mean(X_Harm_Index, na.rm = TRUE),
    InstitutionTrust = Inst_Trust_Index - mean(Inst_Trust_Index, na.rm = TRUE)
  )
```

```{r}
model_hkg <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust  + Edu + Income + Age, data = filter(df_clean, Region == "Hong Kong"))
model_sgp <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust  + Edu + Income + Age, data = filter(df_clean, Region == "Singapore"))
model_twn <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust  + Edu + Income + Age, data = filter(df_clean, Region == "Taiwan"))
model_chn <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust  + Edu + Income + Age, data = filter(df_clean, Region == "China"))

model_full <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust * Region + Edu + Income + Age, data = df_clean)


model_hkg_WithoutInteraction <- lm(ImpactOnCountry ~ PerceivedHarm + InstitutionTrust, 
                    data = filter(df_clean, Region == "Hong Kong"))
model_sgp_WithoutInteraction <- lm(ImpactOnCountry ~ PerceivedHarm + InstitutionTrust, 
                    data = filter(df_clean, Region == "Singapore"))
model_twn_WithoutInteraction <- lm(ImpactOnCountry ~ PerceivedHarm + InstitutionTrust, 
                    data = filter(df_clean, Region == "Taiwan"))
model_chn_WithoutInteraction <- lm(ImpactOnCountry ~ PerceivedHarm + InstitutionTrust, 
                    data = filter(df_clean, Region == "China"))
model_full_WithoutInteraction <- lm(ImpactOnCountry ~ PerceivedHarm * Region + InstitutionTrust * Region, 
                     data = df_clean)


model_hkg_nocontrol <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust, 
                          data = filter(df_clean, Region == "Hong Kong"))
model_sgp_nocontrol <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust, 
                          data = filter(df_clean, Region == "Singapore"))
model_twn_nocontrol <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust, 
                          data = filter(df_clean, Region == "Taiwan"))
model_chn_nocontrol <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust, 
                          data = filter(df_clean, Region == "China"))
model_full_nocontrol <- lm(ImpactOnCountry ~ PerceivedHarm * InstitutionTrust * Region, 
                          data = df_clean)
```

```{r}
# Summaries for Additive Models
summary(model_hkg_WithoutInteraction)
summary(model_sgp_WithoutInteraction)
summary(model_twn_WithoutInteraction)
summary(model_chn_WithoutInteraction)
summary(model_full_WithoutInteraction)
```

```{r}
# Summaries for Moderation Models
summary(model_hkg)
summary(model_sgp)
summary(model_twn)
summary(model_chn)
summary(model_full) # Full interaction model with Region
```

```{r}
# Summaries for No-Control Models
summary(model_hkg_nocontrol)
summary(model_sgp_nocontrol)
summary(model_twn_nocontrol)
summary(model_chn_nocontrol)
```
